<!-- ======================= social.html ======================= -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Social – DataDuels</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    .list { width: min(720px, 92%); margin: 0 auto; text-align:left; }
    .item { display:flex; align-items:center; justify-content:space-between; gap:12px; padding:12px 0; border-bottom:1px solid #e5e7eb; }
    .item:last-child { border-bottom:none; }
    .who { display:flex; align-items:center; gap:12px; }
    .who img { width:40px; height:40px; border-radius:50%; border:1px solid #e5e7eb; }
    .meta { color:#4113ae; font-size:12px; }
    .toolbar { display:flex; gap:8px; justify-content:center; margin-bottom:12px; flex-wrap:wrap; }
    #loading { text-align:center; padding:20px; color:#666; }
    .empty-state { text-align:center; padding:30px; color:#666; }
    .friends-dropdown { width: 100%; padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px; margin-top: 8px; }
  </style>
</head>
<body>
  <main class="page">
    <section class="card list" aria-label="Social">
      <h1>Social</h1>
      <p>View friends and manage your leagues.</p>

      <div class="toolbar">
        <button id="createLeagueBtn" class="btn primary">Create League</button>
      </div>

      <!-- League Dialog -->
      <dialog id="leagueDialog" aria-label="Create League">
        <form method="dialog" id="leagueForm" class="form" style="padding:16px;">
          <h3 style="margin:0 0 8px;">Create League</h3>
        
          <div>
            <label for="leagueName">League name</label>
            <input id="leagueName" name="name" required placeholder="e.g., Fall 5K Showdown" />
          </div>
        
          <div>
            <label for="leagueDuration">Duration</label>
            <select id="leagueDuration" name="duration" required>
              <option value="1">1 week</option>
              <option value="2" selected>2 weeks</option>
            </select>
            <div class="hint meta">Must be 1–2 weeks.</div>
          </div>
        
          <div>
            <label for="leagueSize">League size</label>
            <input id="leagueSize" name="size" type="number" min="4" max="12" value="6" required />
            <div class="hint meta">Minimum 4, maximum 12 members (including you).</div>
          </div>
        
          <fieldset style="border:0; padding:0; margin:0;">
            <legend style="font-weight:600; margin-bottom:6px;">Invite members (friends only)</legend>
            <div class="hint meta" style="margin-bottom:6px;">Choose from your friends list below.</div>
            <div id="leagueFriendsList" class="invite-grid" style="display:grid; gap:8px;">
              <p class="meta">Loading friends...</p>
            </div>
          </fieldset>
        
          <div class="row-actions" style="justify-content:flex-end; margin-top:8px;">
            <button type="button" id="leagueCancel" class="btn">Cancel</button>
            <button type="submit" class="btn primary">Create</button>
          </div>
        </form>
      </dialog>

      <!-- Friends List Section -->
      <h2 style="font-size:16px; margin:16px 0 8px;">Your Friends</h2>
      <div id="loading">Loading friends...</div>
      <select id="friendsDropdown" class="friends-dropdown" style="display:none;">
        <option value="">Select a friend...</option>
      </select>
      <div id="friendsEmpty" class="empty-state" style="display:none;">
        <p>No friends found.</p>
      </div>

      <!-- Leagues Section -->
      <h2 style="font-size:16px; margin:24px 0 8px;">Your Leagues</h2>
      <p class="meta" id="league-empty">No leagues yet. Create one to get started.</p>
      <div id="league-list"></div>
    </section>
  </main>

  <nav class="tabs" aria-label="Primary navigation">
    <div class="row">
      <a href="profile.html" aria-label="Profile"><div class="icon">Profile</div></a>
      <a href="index.html" aria-label="Home"><div class="icon">Home</div></a>
      <a href="social.html" aria-label="Social" class="active"><div class="icon">Social</div></a>
    </div>
  </nav>

  <script type="module" src="api.js"></script>
  <script src="script.js"></script>
  <script type="module">
  import { API_URL } from './config.js';
  import { db } from '/strava_user_frontend.js';
  import { getAccessToken, initializeAuth } from '/authHelper.js';
  
  (function() {
    const BACKEND_URL = API_URL;
    
    // Initialize auth system (handles automatic token refresh)
    initializeAuth();
    
    // DOM Elements
    const loadingDiv = document.getElementById('loading');
    const friendsDropdown = document.getElementById('friendsDropdown');
    const friendsEmpty = document.getElementById('friendsEmpty');
    const leagueDialog = document.getElementById('leagueDialog');
    const leagueForm = document.getElementById('leagueForm');
    
    // Store friends data for league invites
    let friendsData = [];

    // Load Friends from Leaderboard
    async function loadFriends() {
      try {
        loadingDiv.style.display = 'block';
        friendsDropdown.style.display = 'none';
        friendsEmpty.style.display = 'none';

        // Get current user ID to exclude them from friends list
        let currentUserId = null;
        try {
          const access_token = await getAccessToken();
          const { data: { user } } = await db.auth.getUser(access_token);
          currentUserId = user ? user.id : null;
        } catch (e) {
          console.log('Not authenticated');
        }

        // Fetch leaderboard data
        const response = await fetch(`${BACKEND_URL}/api/leaderboard`);
        if (!response.ok) throw new Error('Failed to load leaderboard');
        
        const data = await response.json();
        loadingDiv.style.display = 'none';

        // Filter out current user and store as friends
        friendsData = data.leaderboard.filter(entry => entry.user_id !== currentUserId);

        if (friendsData.length === 0) {
          friendsEmpty.style.display = 'block';
          return;
        }

        // Populate dropdown
        friendsDropdown.innerHTML = '<option value="">Select a friend...</option>';
        friendsData.forEach(friend => {
          const option = document.createElement('option');
          option.value = friend.user_id;
          option.textContent = `${friend.username} (Rank: #${friend.rank}, Score: ${friend.score})`;
          friendsDropdown.appendChild(option);
        });
        
        friendsDropdown.style.display = 'block';
      } catch (error) {
        console.error('Error loading friends:', error);
        loadingDiv.innerHTML = '<p style="color:#ef4444;">Failed to load friends. Please try again.</p>';
      }
    }

    // League Dialog Controls
    document.getElementById('createLeagueBtn').addEventListener('click', async (e) => {
      e.preventDefault();
      
      // Load friends for league invites
      try {
        // Get current user ID to exclude them from friends list
        let currentUserId = null;
        try {
          const access_token = await getAccessToken();
          const { data: { user } } = await db.auth.getUser(access_token);
          currentUserId = user ? user.id : null;
        } catch (e) {
          console.log('Not authenticated');
        }

        // Use the already loaded friends data
        const friendsListDiv = document.getElementById('leagueFriendsList');
        
        if (friendsData.length === 0) {
          friendsListDiv.innerHTML = '<p class="meta">No friends to invite. Add friends first!</p>';
        } else {
          friendsListDiv.innerHTML = friendsData.map(friend => `
            <label class="inline">
              <input type="checkbox" name="invites" value="${friend.user_id}" /> 
              ${friend.username} (Score: ${friend.score})
            </label>
          `).join('');
        }
      } catch (error) {
        console.error('Error loading friends for league:', error);
        document.getElementById('leagueFriendsList').innerHTML = '<p class="meta" style="color:#ef4444;">Failed to load friends</p>';
      }
      
      leagueDialog.showModal();
    });

    document.getElementById('leagueCancel').addEventListener('click', () => {
      leagueDialog.close();
    });

    // League Management (Backend API)
    async function loadLeagues() {
      try {
        const access_token = await getAccessToken();
        const response = await fetch(`${BACKEND_URL}/leaderboards/my`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ access_token })
        });
        
        if (!response.ok) {
          throw new Error('Failed to load leagues');
        }
        
        const data = await response.json();
        // Combine owned and joined leagues
        const allLeagues = [...(data.owned || []), ...(data.joined || [])];
        return allLeagues;
      } catch (error) {
        console.error('Error loading leagues:', error);
        return [];
      }
    }

    async function renderLeagues() {
      const list = document.getElementById('league-list');
      const emptyMsg = document.getElementById('league-empty');
      
      list.innerHTML = '<p class="meta">Loading leagues...</p>';
      
      try {
        const leagues = await loadLeagues();
        
        list.innerHTML = '';
        
        if (!leagues.length) {
          emptyMsg.style.display = 'block';
          return;
        }
        
        emptyMsg.style.display = 'none';

        leagues.forEach((lg) => {
          const card = document.createElement('div');
          card.className = 'item';
          
          card.innerHTML = `
            <div>
              <div style="font-weight:700;">${lg.name}</div>
              <div class="meta">
                Metric: ${lg.metric || 'score'} • 
                Members: ${lg.members_count || 0}
              </div>
            </div>
            <div class="row-actions">
              <a class="btn" href="leaderboards.html?league_id=${lg.id}">View</a>
            </div>
          `;
          list.appendChild(card);
        });
      } catch (error) {
        console.error('Error rendering leagues:', error);
        list.innerHTML = '<p style="color:#ef4444;">Failed to load leagues</p>';
      }
    }

    leagueForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const name = document.getElementById('leagueName').value.trim();
      const duration = Number(document.getElementById('leagueDuration').value);
      const size = Number(document.getElementById('leagueSize').value);
      const invites = Array.from(leagueForm.querySelectorAll('input[name="invites"]:checked'))
        .map(cb => cb.value);

      const errors = [];
      if (!name) errors.push('League name is required.');
      if (!(duration === 1 || duration === 2)) errors.push('Duration must be 1 or 2 weeks.');
      if (!(Number.isInteger(size) && size >= 4 && size <= 12)) errors.push('League size must be an integer from 4 to 12.');
      if (invites.length + 1 > size) errors.push('Invited members + you cannot exceed the league size.');

      if (errors.length) {
        alert(errors.join('\n'));
        return;
      }

      try {
        // Get access token
        const access_token = await getAccessToken();
        
        // Get current user ID
        const { data: { user } } = await db.auth.getUser(access_token);
        if (!user) {
          throw new Error('Not authenticated');
        }
        
        // Build members list (includes creator + invites)
        // Filter out any empty strings and ensure all are valid user IDs
        // Also remove duplicates and ensure creator isn't duplicated in invites
        const uniqueInvites = [...new Set(invites.filter(id => id && id.trim() !== '' && id !== user.id))];
        const members = [user.id, ...uniqueInvites];
        
        console.log('Creating league with members:', members);
        console.log('Invites selected:', invites);
        console.log('Unique invites (after filtering):', uniqueInvites);
        console.log('Current user ID:', user.id);
        
        if (members.length < 2) {
          alert('Please select at least one friend to invite to the league.');
          return;
        }
        
        // Create league via backend API
        const response = await fetch(`${BACKEND_URL}/leaderboard/create`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            access_token,
            name,
            metric: 'score', // Default to score-based ranking
            members
          })
        });
        
        if (!response.ok) {
          const error = await response.json();
          console.error('League creation error:', error);
          throw new Error(error.error || 'Failed to create league');
        }
        
        const result = await response.json();
        console.log('League created successfully:', result);
        alert(`League "${name}" created successfully with ${members.length} member(s)!`);
        
        leagueForm.reset();
        leagueDialog.close();
        renderLeagues();
      } catch (error) {
        console.error('Error creating league:', error);
        alert(error.message || 'Failed to create league. Please try again.');
      }
    });

    // Initialize
    loadFriends();
    renderLeagues();
  })();
  </script>
</body>
</html>
