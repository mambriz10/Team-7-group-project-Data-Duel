<!-- ======================= social.html ======================= -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Social – DataDuels</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    .list { width: min(720px, 92%); margin: 0 auto; text-align:left; }
    .item { display:flex; align-items:center; justify-content:space-between; gap:12px; padding:12px 0; border-bottom:1px solid #e5e7eb; }
    .item:last-child { border-bottom:none; }
    .who { display:flex; align-items:center; gap:12px; }
    .who img { width:40px; height:40px; border-radius:50%; border:1px solid #e5e7eb; }
    .meta { color:#4113ae; font-size:12px; }
    .toolbar { display:flex; gap:8px; justify-content:center; margin-bottom:12px; flex-wrap:wrap; }
    .search-box { display:flex; gap:8px; margin-bottom:16px; }
    .search-box input { flex:1; padding:8px 12px; border:1px solid #e5e7eb; border-radius:8px; }
    .badge-status { display:inline-block; padding:2px 8px; border-radius:12px; font-size:11px; font-weight:600; }
    .badge-friends { background:#10b981; color:white; }
    .badge-pending { background:#f59e0b; color:white; }
    .badge-sent { background:#6366f1; color:white; }
    #loading { text-align:center; padding:20px; color:#666; }
    .empty-state { text-align:center; padding:30px; color:#666; }
  </style>
</head>
<body>
  <main class="page">
    <section class="card list" aria-label="Social">
      <h1>Social</h1>
      <p>Connect with other runners and create leagues.</p>

      <div class="toolbar">
        <button id="searchBtn" class="btn primary">Find Friends</button>
        <button id="createLeagueBtn" class="btn primary">Create League</button>
      </div>

      <!-- Search Dialog -->
      <dialog id="searchDialog" aria-label="Find Friends">
        <div style="padding:20px; min-width:400px;">
          <h3 style="margin:0 0 16px;">Find Friends</h3>
          
          <div class="search-box">
            <input type="text" id="searchInput" placeholder="Search by name or username..." />
            <button id="searchExecuteBtn" class="btn primary">Search</button>
          </div>

          <div id="searchResults"></div>
          <div id="searchLoading" style="display:none; text-align:center; padding:20px;">
            <p>Searching...</p>
          </div>
          <div id="searchEmpty" class="empty-state" style="display:none;">
            <p>No users found. Try a different search term.</p>
          </div>

          <div style="text-align:right; margin-top:16px;">
            <button id="searchCloseBtn" class="btn">Close</button>
          </div>
        </div>
      </dialog>

      <!-- League Dialog -->
      <dialog id="leagueDialog" aria-label="Create League">
        <form method="dialog" id="leagueForm" class="form" style="padding:16px;">
          <h3 style="margin:0 0 8px;">Create League</h3>
        
          <div>
            <label for="leagueName">League name</label>
            <input id="leagueName" name="name" required placeholder="e.g., Fall 5K Showdown" />
          </div>
        
          <div>
            <label for="leagueDuration">Duration</label>
            <select id="leagueDuration" name="duration" required>
              <option value="1">1 week</option>
              <option value="2" selected>2 weeks</option>
            </select>
            <div class="hint meta">Must be 1–2 weeks.</div>
          </div>
        
          <div>
            <label for="leagueSize">League size</label>
            <input id="leagueSize" name="size" type="number" min="4" max="12" value="6" required />
            <div class="hint meta">Minimum 4, maximum 12 members (including you).</div>
          </div>
        
          <fieldset style="border:0; padding:0; margin:0;">
            <legend style="font-weight:600; margin-bottom:6px;">Invite members (friends only)</legend>
            <div class="hint meta" style="margin-bottom:6px;">Choose from your friends list below.</div>
            <div id="leagueFriendsList" class="invite-grid" style="display:grid; gap:8px;">
              <p class="meta">Loading friends...</p>
            </div>
          </fieldset>
        
          <div class="row-actions" style="justify-content:flex-end; margin-top:8px;">
            <button type="button" id="leagueCancel" class="btn">Cancel</button>
            <button type="submit" class="btn primary">Create</button>
          </div>
        </form>
      </dialog>

      <!-- Friend Requests Section -->
      <div id="requestsSection" style="display:none;">
        <h2 style="font-size:16px; margin:16px 0 8px;">Friend Requests</h2>
        <div id="requestsList"></div>
      </div>

      <!-- Friends List Section -->
      <h2 style="font-size:16px; margin:16px 0 8px;">Your Friends</h2>
      <div id="loading">Loading friends...</div>
      <div id="friendsList"></div>
      <div id="friendsEmpty" class="empty-state" style="display:none;">
        <p>No friends yet. Click "Find Friends" to connect with other runners!</p>
      </div>

      <!-- Leagues Section -->
      <h2 style="font-size:16px; margin:24px 0 8px;">Your Leagues</h2>
      <p class="meta" id="league-empty">No leagues yet. Create one to get started.</p>
      <div id="league-list"></div>
    </section>
  </main>

  <nav class="tabs" aria-label="Primary navigation">
    <div class="row">
      <a href="profile.html" aria-label="Profile"><div class="icon">Profile</div></a>
      <a href="index.html" aria-label="Home"><div class="icon">Home</div></a>
      <a href="social.html" aria-label="Social" class="active"><div class="icon">Social</div></a>
    </div>
  </nav>

  <script type="module" src="api.js"></script>
  <script src="script.js"></script>
  <script type="module">
  import { API_URL } from './config.js';
  import { db } from '/strava_user_frontend.js';
  
  (function() {
    const BACKEND_URL = API_URL;
    
    // Helper to get access token
    async function getAccessToken() {
      try {
        const { data: { session } } = await db.auth.getSession();
        if (!session) {
          throw new Error('No active session');
        }
        return session.access_token;
      } catch (error) {
        console.error('Error getting access token:', error);
        throw error;
      }
    }
    
    // DOM Elements
    const loadingDiv = document.getElementById('loading');
    const friendsList = document.getElementById('friendsList');
    const friendsEmpty = document.getElementById('friendsEmpty');
    const requestsSection = document.getElementById('requestsSection');
    const requestsList = document.getElementById('requestsList');
    const searchDialog = document.getElementById('searchDialog');
    const searchResults = document.getElementById('searchResults');
    const searchLoading = document.getElementById('searchLoading');
    const searchEmpty = document.getElementById('searchEmpty');
    const searchInput = document.getElementById('searchInput');

    // Load Friends
    async function loadFriends() {
      try {
        loadingDiv.style.display = 'block';
        friendsList.innerHTML = '';
        friendsEmpty.style.display = 'none';

        const response = await fetch(`${BACKEND_URL}/api/friends`);
        if (!response.ok) throw new Error('Failed to load friends');
        
        const data = await response.json();
        loadingDiv.style.display = 'none';

        if (data.friends.length === 0) {
          friendsEmpty.style.display = 'block';
          return;
        }

        data.friends.forEach(friend => {
          const item = document.createElement('div');
          item.className = 'item';
          item.innerHTML = `
            <div class="who">
              <img src="${friend.avatar}" alt="${friend.name}" />
              <div>
                <div style="font-weight:700;">${friend.name}</div>
                <div class="meta">
                  @${friend.username} • Last run: ${friend.last_run_distance} km • 
                  Streak: ${friend.streak} days • Score: ${friend.score}
                </div>
              </div>
            </div>
            <div style="display:flex; gap:8px;">
              <a class="btn" href="leaderboards.html">Leaderboard</a>
              <button class="btn" onclick="removeFriend('${friend.user_id}', '${friend.name}')">Remove</button>
            </div>
          `;
          friendsList.appendChild(item);
        });
      } catch (error) {
        console.error('Error loading friends:', error);
        loadingDiv.innerHTML = '<p style="color:#ef4444;">Failed to load friends. Please try again.</p>';
      }
    }

    // Load Friend Requests
    async function loadRequests() {
      try {
        const response = await fetch(`${BACKEND_URL}/api/friends/requests`);
        if (!response.ok) return;
        
        const data = await response.json();
        
        if (data.requests.length === 0) {
          requestsSection.style.display = 'none';
          return;
        }

        requestsSection.style.display = 'block';
        requestsList.innerHTML = '';

        data.requests.forEach(request => {
          const item = document.createElement('div');
          item.className = 'item';
          item.innerHTML = `
            <div class="who">
              <img src="${request.avatar}" alt="${request.name}" />
              <div>
                <div style="font-weight:700;">${request.name}</div>
                <div class="meta">@${request.username} • ${request.location || 'Unknown location'}</div>
              </div>
            </div>
            <div style="display:flex; gap:8px;">
              <button class="btn primary" onclick="acceptRequest('${request.user_id}', '${request.name}')">Accept</button>
              <button class="btn" onclick="rejectRequest('${request.user_id}')">Decline</button>
            </div>
          `;
          requestsList.appendChild(item);
        });
      } catch (error) {
        console.error('Error loading requests:', error);
      }
    }

    // Search Users
    async function searchUsers(query) {
      if (!query || query.length < 2) {
        alert('Please enter at least 2 characters to search');
        return;
      }

      searchResults.innerHTML = '';
      searchLoading.style.display = 'block';
      searchEmpty.style.display = 'none';

      try {
        const response = await fetch(`${BACKEND_URL}/api/friends/search?q=${encodeURIComponent(query)}`);
        if (!response.ok) throw new Error('Search failed');
        
        const data = await response.json();
        searchLoading.style.display = 'none';

        if (data.users.length === 0) {
          searchEmpty.style.display = 'block';
          return;
        }

        data.users.forEach(user => {
          const item = document.createElement('div');
          item.className = 'item';
          
          let actionButton = '';
          let statusBadge = '';
          
          switch(user.friendship_status) {
            case 'friends':
              statusBadge = '<span class="badge-status badge-friends">Friends</span>';
              break;
            case 'pending_sent':
              statusBadge = '<span class="badge-status badge-sent">Request Sent</span>';
              break;
            case 'pending_received':
              statusBadge = '<span class="badge-status badge-pending">Pending</span>';
              actionButton = `<button class="btn primary" onclick="acceptRequest('${user.user_id}', '${user.name}')">Accept</button>`;
              break;
            default:
              actionButton = `<button class="btn primary" onclick="sendRequest('${user.user_id}', '${user.name}')">Add Friend</button>`;
          }
          
          item.innerHTML = `
            <div class="who">
              <img src="${user.avatar}" alt="${user.name}" />
              <div>
                <div style="font-weight:700;">${user.name} ${statusBadge}</div>
                <div class="meta">@${user.username} • ${user.location || 'Unknown location'}</div>
              </div>
            </div>
            ${actionButton}
          `;
          searchResults.appendChild(item);
        });
      } catch (error) {
        console.error('Error searching users:', error);
        searchLoading.style.display = 'none';
        searchResults.innerHTML = '<p style="color:#ef4444; padding:20px;">Search failed. Please try again.</p>';
      }
    }

    // Send Friend Request
    window.sendRequest = async function(userId, userName) {
      try {
        const response = await fetch(`${BACKEND_URL}/api/friends/request`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ friend_id: userId })
        });

        const data = await response.json();
        
        if (response.ok) {
          alert(`Friend request sent to ${userName}!`);
          searchDialog.close();
          loadFriends();
        } else {
          alert(data.error || 'Failed to send friend request');
        }
      } catch (error) {
        console.error('Error sending request:', error);
        alert('Failed to send friend request');
      }
    };

    // Accept Friend Request
    window.acceptRequest = async function(userId, userName) {
      try {
        const response = await fetch(`${BACKEND_URL}/api/friends/accept/${userId}`, {
          method: 'POST'
        });

        const data = await response.json();
        
        if (response.ok) {
          alert(`You are now friends with ${userName}!`);
          if (searchDialog.open) searchDialog.close();
          loadFriends();
          loadRequests();
        } else {
          alert(data.error || 'Failed to accept friend request');
        }
      } catch (error) {
        console.error('Error accepting request:', error);
        alert('Failed to accept friend request');
      }
    };

    // Reject Friend Request
    window.rejectRequest = async function(userId) {
      try {
        const response = await fetch(`${BACKEND_URL}/api/friends/reject/${userId}`, {
          method: 'POST'
        });

        if (response.ok) {
          alert('Friend request declined');
          loadRequests();
        } else {
          alert('Failed to decline friend request');
        }
      } catch (error) {
        console.error('Error rejecting request:', error);
        alert('Failed to decline friend request');
      }
    };

    // Remove Friend
    window.removeFriend = async function(userId, userName) {
      if (!confirm(`Remove ${userName} from your friends?`)) return;

      try {
        const response = await fetch(`${BACKEND_URL}/api/friends/remove/${userId}`, {
          method: 'DELETE'
        });

        if (response.ok) {
          alert(`${userName} has been removed from your friends`);
          loadFriends();
        } else {
          alert('Failed to remove friend');
        }
      } catch (error) {
        console.error('Error removing friend:', error);
        alert('Failed to remove friend');
      }
    };

    // Search Dialog Controls
    document.getElementById('searchBtn').addEventListener('click', () => {
      searchDialog.showModal();
      searchInput.value = '';
      searchResults.innerHTML = '';
      searchEmpty.style.display = 'none';
      searchInput.focus();
    });

    document.getElementById('searchCloseBtn').addEventListener('click', () => {
      searchDialog.close();
    });

    document.getElementById('searchExecuteBtn').addEventListener('click', () => {
      const query = searchInput.value.trim();
      searchUsers(query);
    });

    searchInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        const query = searchInput.value.trim();
        searchUsers(query);
      }
    });

    // League Dialog Controls
    const leagueDialog = document.getElementById('leagueDialog');
    const leagueForm = document.getElementById('leagueForm');
    
    document.getElementById('createLeagueBtn').addEventListener('click', async (e) => {
      e.preventDefault();
      
      // Load friends for league invites
      try {
        const response = await fetch(`${BACKEND_URL}/api/friends`);
        const data = await response.json();
        
        const friendsListDiv = document.getElementById('leagueFriendsList');
        
        if (data.friends.length === 0) {
          friendsListDiv.innerHTML = '<p class="meta">No friends to invite. Add friends first!</p>';
        } else {
          friendsListDiv.innerHTML = data.friends.map(friend => `
            <label class="inline">
              <input type="checkbox" name="invites" value="${friend.user_id}" /> 
              ${friend.name} (@${friend.username})
            </label>
          `).join('');
        }
      } catch (error) {
        console.error('Error loading friends for league:', error);
      }
      
      leagueDialog.showModal();
    });

    document.getElementById('leagueCancel').addEventListener('click', () => {
      leagueDialog.close();
    });

    // League Management (Backend API)
    async function loadLeagues() {
      try {
        const access_token = await getAccessToken();
        const response = await fetch(`${BACKEND_URL}/leaderboards/my`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ access_token })
        });
        
        if (!response.ok) {
          throw new Error('Failed to load leagues');
        }
        
        const data = await response.json();
        // Combine owned and joined leagues
        const allLeagues = [...(data.owned || []), ...(data.joined || [])];
        return allLeagues;
      } catch (error) {
        console.error('Error loading leagues:', error);
        return [];
      }
    }

    async function renderLeagues() {
      const list = document.getElementById('league-list');
      const emptyMsg = document.getElementById('league-empty');
      
      list.innerHTML = '<p class="meta">Loading leagues...</p>';
      
      try {
        const leagues = await loadLeagues();
        
        // Get current user ID for creator checks
        const currentUserId = await getCurrentUserId();
        
        list.innerHTML = '';
        
        if (!leagues.length) {
          emptyMsg.style.display = 'block';
          return;
        }
        
        emptyMsg.style.display = 'none';

        leagues.forEach((lg) => {
          const card = document.createElement('div');
          card.className = 'item';
          
          // Check if current user is creator (for delete and add member buttons)
          const isCreator = currentUserId && lg.creator_id === currentUserId;
          
          card.innerHTML = `
            <div>
              <div style="font-weight:700;">${lg.name}</div>
              <div class="meta">
                Metric: ${lg.metric || 'score'} • 
                Members: ${lg.members_count || 0}
              </div>
            </div>
            <div class="row-actions">
              <a class="btn" href="leaderboards.html?league_id=${lg.id}">View</a>
              ${isCreator ? `<button class="btn" onclick="addMemberToLeague('${lg.id}', '${lg.name}')">Add Member</button>` : ''}
              ${isCreator ? `<button class="btn" onclick="deleteLeague('${lg.id}', '${lg.name}')">Delete</button>` : ''}
            </div>
          `;
          list.appendChild(card);
        });
      } catch (error) {
        console.error('Error rendering leagues:', error);
        list.innerHTML = '<p style="color:#ef4444;">Failed to load leagues</p>';
      }
    }

    leagueForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const name = document.getElementById('leagueName').value.trim();
      const duration = Number(document.getElementById('leagueDuration').value);
      const size = Number(document.getElementById('leagueSize').value);
      const invites = Array.from(leagueForm.querySelectorAll('input[name="invites"]:checked'))
        .map(cb => cb.value);

      const errors = [];
      if (!name) errors.push('League name is required.');
      if (!(duration === 1 || duration === 2)) errors.push('Duration must be 1 or 2 weeks.');
      if (!(Number.isInteger(size) && size >= 4 && size <= 12)) errors.push('League size must be an integer from 4 to 12.');
      if (invites.length + 1 > size) errors.push('Invited members + you cannot exceed the league size.');

      if (errors.length) {
        alert(errors.join('\n'));
        return;
      }

      try {
        // Get access token
        const access_token = await getAccessToken();
        
        // Get current user ID
        const { data: { user } } = await db.auth.getUser(access_token);
        if (!user) {
          throw new Error('Not authenticated');
        }
        
        // Build members list (includes creator + invites)
        const members = [user.id, ...invites];
        
        // Create league via backend API
        const response = await fetch(`${BACKEND_URL}/leaderboard/create`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            access_token,
            name,
            metric: 'score', // Default to score-based ranking
            members
          })
        });
        
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Failed to create league');
        }
        
        const result = await response.json();
        alert(`League "${name}" created successfully!`);
        
        leagueForm.reset();
        leagueDialog.close();
        renderLeagues();
      } catch (error) {
        console.error('Error creating league:', error);
        alert(error.message || 'Failed to create league. Please try again.');
      }
    });

    // Get current user ID for creator checks
    async function getCurrentUserId() {
      try {
        const access_token = await getAccessToken();
        const { data: { user } } = await db.auth.getUser(access_token);
        return user ? user.id : null;
      } catch (error) {
        console.error('Error getting current user:', error);
        return null;
      }
    }

    // Delete League
    window.deleteLeague = async function(leagueId, leagueName) {
      if (!confirm(`Are you sure you want to delete "${leagueName}"? This action cannot be undone.`)) {
        return;
      }
      
      try {
        const access_token = await getAccessToken();
        const response = await fetch(`${BACKEND_URL}/leaderboard/${leagueId}/delete`, {
          method: 'DELETE',
          headers: { 
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${access_token}`
          },
          body: JSON.stringify({ access_token })
        });
        
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Failed to delete league');
        }
        
        const result = await response.json();
        alert(result.message || 'League deleted successfully!');
        renderLeagues();
      } catch (error) {
        console.error('Error deleting league:', error);
        alert(error.message || 'Failed to delete league. Please try again.');
      }
    };

    // Add Member to League
    window.addMemberToLeague = async function(leagueId, leagueName) {
      // Create a dialog for adding members
      const dialog = document.createElement('dialog');
      dialog.innerHTML = `
        <div style="padding:20px; min-width:400px;">
          <h3 style="margin:0 0 16px;">Add Member to "${leagueName}"</h3>
          
          <div id="addMemberFriendsList" style="max-height:300px; overflow-y:auto; margin-bottom:16px;">
            <p class="meta">Loading friends...</p>
          </div>
          
          <div style="text-align:right; margin-top:16px;">
            <button id="addMemberCancel" class="btn">Cancel</button>
            <button id="addMemberSubmit" class="btn primary">Add Selected</button>
          </div>
        </div>
      `;
      document.body.appendChild(dialog);
      
      // Load friends
      try {
        const response = await fetch(`${BACKEND_URL}/api/friends`);
        const data = await response.json();
        
        const friendsListDiv = dialog.querySelector('#addMemberFriendsList');
        
        if (data.friends.length === 0) {
          friendsListDiv.innerHTML = '<p class="meta">No friends to add. Add friends first!</p>';
        } else {
          // Get current league members to exclude them
          let existingMemberIds = [];
          try {
            const leagueInfo = await api.getLeagueInfo(leagueId);
            existingMemberIds = leagueInfo.member_ids || [];
          } catch (error) {
            console.error('Error getting league info:', error);
            // Continue without filtering if we can't get league info
          }
          
          const availableFriends = data.friends.filter(f => !existingMemberIds.includes(f.user_id));
          
          if (availableFriends.length === 0) {
            friendsListDiv.innerHTML = '<p class="meta">All your friends are already in this league!</p>';
          } else {
            friendsListDiv.innerHTML = availableFriends.map(friend => `
              <label class="inline" style="display:block; padding:8px; border-bottom:1px solid var(--border);">
                <input type="checkbox" name="add_member" value="${friend.user_id}" /> 
                ${friend.name} (@${friend.username})
              </label>
            `).join('');
          }
        }
      } catch (error) {
        console.error('Error loading friends:', error);
        dialog.querySelector('#addMemberFriendsList').innerHTML = 
          '<p style="color:#ef4444;">Failed to load friends</p>';
      }
      
      // Show dialog
      dialog.showModal();
      
      // Cancel button
      dialog.querySelector('#addMemberCancel').addEventListener('click', () => {
        dialog.close();
        document.body.removeChild(dialog);
      }, { once: true });
      
      // Submit button
      dialog.querySelector('#addMemberSubmit').addEventListener('click', async () => {
        const selected = Array.from(dialog.querySelectorAll('input[name="add_member"]:checked'))
          .map(cb => cb.value);
        
        if (selected.length === 0) {
          alert('Please select at least one friend to add');
          return;
        }
        
        try {
          const access_token = await getAccessToken();
          
          // Add each selected member
          let successCount = 0;
          let errorCount = 0;
          
          for (const userId of selected) {
            try {
              const response = await fetch(`${BACKEND_URL}/leaderboard/add_member`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  access_token,
                  leaderboard_id: leagueId,
                  user_id: userId
                })
              });
              
              if (response.ok) {
                successCount++;
              } else {
                const error = await response.json();
                console.error(`Failed to add ${userId}:`, error);
                errorCount++;
              }
            } catch (error) {
              console.error(`Error adding ${userId}:`, error);
              errorCount++;
            }
          }
          
          if (successCount > 0) {
            alert(`Successfully added ${successCount} member(s)${errorCount > 0 ? ` (${errorCount} failed)` : ''}!`);
            dialog.close();
            document.body.removeChild(dialog);
            renderLeagues(); // Refresh league list
          } else {
            alert(`Failed to add members. Please try again.`);
          }
        } catch (error) {
          console.error('Error adding members:', error);
          alert('Failed to add members. Please try again.');
        }
      }, { once: true });
    };

    // Auto-friend all users for MVP demo (ensures all users are friends with each other)
    async function initializeAutoFriends() {
      try {
        console.log('[INIT] Setting up auto-friends for MVP demo...');
        const response = await fetch(`${BACKEND_URL}/api/friends/auto-friend-all`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        
        if (response.ok) {
          const result = await response.json();
          console.log(`[INIT] Auto-friends setup complete: ${result.message || 'Success'}`);
          if (result.friendships_created) {
            console.log(`[INIT] Created ${result.friendships_created} friendships`);
          }
        } else {
          console.warn('[INIT] Auto-friends setup failed (non-critical):', await response.text());
        }
      } catch (error) {
        console.warn('[INIT] Auto-friends setup error (non-critical):', error);
        // Non-critical error - don't block initialization
      }
    }

    // Initialize
    // First, set up auto-friends for MVP demo, then load data
    initializeAutoFriends().then(() => {
      loadFriends();
      loadRequests();
      renderLeagues();
    });
  })();
  </script>
</body>
</html>
