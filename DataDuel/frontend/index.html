
<!-- ======================= index.html (HOME) ======================= -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Home ‚Äì DataDuels</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <main class="page">
    <section class="card home-card">
      <div class="hero-section">
        <h1 class="gradient-text">DataDuel</h1>
        <p class="subtitle">Fair competition through improvement-based scoring</p>
      </div>
      
      <div id="authStatus" class="status-card">
        <div id="statusContent">
          <p style="margin:0;">Checking status...</p>
        </div>
      </div>
      
      <div class="action-grid">
        <a class="action-card primary" href="leaderboards.html">
          <div class="action-icon">üèÜ</div>
          <div class="action-text">
            <strong>Leaderboards</strong>
            <span>See rankings</span>
          </div>
        </a>
        <a class="action-card primary" href="profile.html">
          <div class="action-icon">üë§</div>
          <div class="action-text">
            <strong>My Profile</strong>
            <span>View stats</span>
          </div>
        </a> 
        <a id="connectStravaBtn" class="action-card primary" href="http://localhost:5500/strava.html" style="display:none;">
          <div class="action-icon">üîó</div>
          <div class="action-text">
            <strong>Connect Strava</strong>
            <span>Link account</span>
          </div>
        </a>
        <!-- <button id="syncBtn" class="action-card sync-card" style="display:none;">
          <div class="action-icon">üîÑ</div>
          <div class="action-text">
            <strong>Sync Activities</strong>
            <span>Update data</span>
          </div>
        </button> -->
        <button id="testLoginBtn" class="action-card" style="background:var(--brand); color:white; border:none;">
          <div class="action-icon">üîê</div>
          <div class="action-text">
            <strong>Test Login</strong>
            <span>Dev mode</span>
          </div>
        </button> 
      </div>

      <div id="activitiesOutput"></div>
    </section>
  </main>
  

  <!-- Bottom tabs: Profile, Home, Social, Routes -->
  <nav class="tabs" aria-label="Primary navigation">
    <div class="row">
      <a href="profile.html" aria-label="Profile"><div class="icon">Profile</div></a>
      <a href="index.html" aria-label="Home" class="active"><div class="icon">Home</div></a>
      <a href="social.html" aria-label="Social"><div class="icon">Social</div></a>
      <a href="routes.html" aria-label="Routes"><div class="icon">Routes</div></a>
    </div>
  </nav>

  <script type="module" src="api.js"></script>
  <script src="script.js"></script>
  <script type="module">
    import { API_URL } from './config.js';
    import { db } from "/strava_user_frontend.js";
    async function checkStatus() {
      try {
        const { data: { session } } = await db.auth.getSession();

        //const status = await api.getStatus();
        const statusContent = document.getElementById('statusContent');
        
        if (session) {
          statusContent.innerHTML = `
            <p style="margin:0; color:#10b981;">[Connected] Connected to Strava</p>
          `;
          const syncBtn = document.getElementById('syncBtn');
          if (syncBtn) syncBtn.style.display = 'flex';
          const connectBtn = document.getElementById('connectStravaBtn');
          if (connectBtn) connectBtn.style.display = 'none';
        } else {
          statusContent.innerHTML = `
            <p style="margin:0; color:#f59e0b;">[Warning] Not connected to Strava</p>
            <p style="margin:4px 0 0 0; font-size:13px; color:var(--muted);">Connect your Strava account to get started</p>
          `;
          const connectBtn = document.getElementById('connectStravaBtn');
          if (connectBtn) {
            connectBtn.href = 'http://localhost:5500/Strava.html';
            connectBtn.style.display = 'flex';
          }
        }
      } catch (error) {
        console.error('Status check failed:', error);
        document.getElementById('statusContent').innerHTML = `
          <p style="margin:0; color:#ef4444;">[Error] Backend not reachable</p>
          <p style="font-size:13px; margin:4px 0 0 0; color:var(--muted);">Backend URL: ${API_URL}</p>

        `;
      }
    }
    
    // Handle sync button
    const syncBtn = document.getElementById('syncBtn');
    if (syncBtn) {
      syncBtn.addEventListener('click', async () => {
      const btn = document.getElementById('syncBtn');
      btn.textContent = 'Syncing...';
      btn.disabled = true;
      
      try {
        //const result = await api.syncActivities();
        alert(`Sync successful!\\n\\nWorkouts: ${result.metrics.total_workouts}\\nDistance: ${result.metrics.total_distance_km} km\\nScore: ${result.metrics.score}`);
        checkStatus();
      } catch (error) {
        alert('[Error] Sync failed: ' + error.message);
      } finally {
        btn.textContent = 'Sync Activities';
        btn.disabled = false;
      }
      });
    }
    
    // Set up Connect Strava button
    const connectStravaBtn = document.getElementById('connectStravaBtn');
    if (connectStravaBtn) {
      connectStravaBtn.addEventListener('click', (e) => {
        e.preventDefault();
        window.location.href = connectStravaBtn.href;
      });
    }
    
    // Check status on load
    checkStatus();

    // Handle test login button
    // const testLoginBtn = document.getElementById('testLoginBtn');
    // if (testLoginBtn) {
    //   testLoginBtn.addEventListener('click', async () => {
    //   const btn = document.getElementById('testLoginBtn');
    //   btn.textContent = 'Logging in...';
    //   btn.disabled = true;
      
    //   try {
    //     const response = await fetch(`${API_URL}/api/test-login`, {
    //       method: 'POST',
    //       headers: {
    //         'Content-Type': 'application/json'
    //       }
    //     });
        
    //     const result = await response.json();
        
    //     if (response.ok) {
    //       alert(`Test login successful!\\n\\nAthlete ID: ${result.athlete_id}\\n\\nYou can now test all features.`);
    //       // Refresh status to show connected state
    //       checkStatus();
    //     } else {
    //       alert(`Test login failed:\\n\\n${result.error || 'Unknown error'}\\n\\n${result.message || ''}\\n\\n${result.details || ''}`);
    //     }
    //   } catch (error) {
    //     alert(`Test login error: ${error.message}`);
    //   } finally {
    //     btn.textContent = 'Test Login';
    //     btn.disabled = false;
    //   }
    //   });
    // }

    async function testStravaActivities() {
      const output = document.getElementById("activitiesOutput");
      output.textContent = "Loading activities...\n";

      try {
        const res = await fetch(`${API_URL}/strava/activities`);

        if (!res.ok) {
          output.textContent = `Error: ${res.status}`;
          return;
        }

        const activities = await res.json();
        //output.textContent = JSON.stringify(activities, null, 2);

        const { data: { session } } = await db.auth.getSession();
        if (!session) {
            console.error("No active session found!");
            return;
        }
        const res2 = await fetch(`${API_URL}/person/update-activities`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                access_token: session.access_token,
                activities: activities
            })
        });
        const ac = res2.json();
        console.log("this is the data: " + JSON.stringify(ac, null, 2));
        output.textContent = "";

        const user_id = session.user.id
        const result = await fetch(`${API_URL}/user/calculate_score`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ user_id: session.user.id })
        });
        
        //calculate the score;

        // Note: Activity update should be handled separately if needed
        // The original implementation didn't automatically update activities here
        return activities;
      } catch (err) {
        output.textContent = "Request failed: " + err.message;
      }
    }
    testStravaActivities();
  </script>
</body>
</html>
