
<!-- ======================= index.html (HOME) ======================= -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Home â€“ DataDuels</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <main class="page">
    <section class="card">
      <h1>DataDuel</h1>
      <p>Fair competition through improvement-based scoring</p>
      
      <div id="authStatus" style="margin:20px 0; padding:16px; border-radius:12px; background:#f5f3ff;">
        <div id="statusContent">
          <p style="margin:0;">Checking status...</p>
        </div>
      </div>
      
      <div style="display:flex; gap:12px; justify-content:center; flex-wrap:wrap;">
        <a class="btn primary" href="leaderboards.html">View Leaderboards</a>
        <a class="btn" href="profile.html">My Profile</a>
        <button id="syncBtn" class="btn" style="display:none;">Sync Activities</button>
        <button id="testLoginBtn" class="btn" style="background:#8b5cf6; color:white;">Test Login</button>
      </div>

      <div id="activitiesOutput"></div>
    </section>
  </main>
  

  <!-- Bottom tabs: Profile, Settings, Home, Social, Routes -->
  <nav class="tabs" aria-label="Primary navigation">
    <div class="row">
      <a href="profile.html" aria-label="Profile"><div class="icon">Profile</div></a>
      <a href="settings.html" aria-label="Settings"><div class="icon">Settings</div></a>
      <a href="login.html" aria-label="Home" class="active"><div class="icon">Home</div></a>
      <a href="social.html" aria-label="Social"><div class="icon">Social</div></a>
      <a href="routes.html" aria-label="Routes"><div class="icon">Routes</div></a>
    </div>
  </nav>

  <script type="module" src="api.js"></script>
  <script src="script.js"></script>
  <script type="module">
    import { API_URL } from './config.js';

    async function checkStatus() {
      try {
        const status = await api.getStatus();
        const statusContent = document.getElementById('statusContent');
        
        if (status.authenticated) {
          statusContent.innerHTML = `
            <p style="margin:0; color:#10b981;">[Connected] Connected to Strava</p>
            <p style="margin:4px 0 0 0; font-size:13px; color:#666;">User ID: ${status.athlete_id}</p>
          `;
          document.getElementById('syncBtn').style.display = 'inline-block';
        } else {
          statusContent.innerHTML = `
            <p style="margin:0; color:#f59e0b;">[Warning] Not connected to Strava</p>
            <a class="btn primary" href="${API_URL}/auth/strava" style="margin-top:8px;">Connect Strava</a>
          `;
        }
      } catch (error) {
        console.error('Status check failed:', error);
        document.getElementById('statusContent').innerHTML = `
          <p style="margin:0; color:#ef4444;">[Error] Backend not reachable</p>
          <p style="font-size:13px; margin:4px 0 0 0;">Backend URL: ${API_URL}</p>
        `;
      }
    }
    
    // Handle sync button
    document.getElementById('syncBtn').addEventListener('click', async () => {
      const btn = document.getElementById('syncBtn');
      btn.textContent = 'Syncing...';
      btn.disabled = true;
      
      try {
        const result = await api.syncActivities();
        alert(`Sync successful!\\n\\nWorkouts: ${result.metrics.total_workouts}\\nDistance: ${result.metrics.total_distance_km} km\\nScore: ${result.metrics.score}`);
        checkStatus();
      } catch (error) {
        alert('[Error] Sync failed: ' + error.message);
      } finally {
        btn.textContent = 'Sync Activities';
        btn.disabled = false;
      }
    });
    
    // Check status on load
    checkStatus();

    // Handle test login button
    document.getElementById('testLoginBtn').addEventListener('click', async () => {
      const btn = document.getElementById('testLoginBtn');
      btn.textContent = 'Logging in...';
      btn.disabled = true;
      
      try {
        const response = await fetch(`${API_URL}/api/test-login`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        
        const result = await response.json();
        
        if (response.ok) {
          alert(`Test login successful!\\n\\nAthlete ID: ${result.athlete_id}\\n\\nYou can now test all features.`);
          // Refresh status to show connected state
          checkStatus();
        } else {
          alert(`Test login failed:\\n\\n${result.error || 'Unknown error'}\\n\\n${result.message || ''}\\n\\n${result.details || ''}`);
        }
      } catch (error) {
        alert(`Test login error: ${error.message}`);
      } finally {
        btn.textContent = 'Test Login';
        btn.disabled = false;
      }
    });

    async function testStravaActivities() {
      const output = document.getElementById("activitiesOutput");
      output.textContent = "Loading activities...\n";

      try {
        const res = await fetch(`${API_URL}/strava/activities`);

        if (!res.ok) {
          output.textContent = `Error: ${res.status}`;
          return;
        }

        const activities = await res.json();
        output.textContent = JSON.stringify(activities, null, 2);

        // Note: Activity update should be handled separately if needed
        // The original implementation didn't automatically update activities here
        return activities;
      } catch (err) {
        output.textContent = "Request failed: " + err.message;
      }
    }
    testStravaActivities();
  </script>
</body>
</html>
