<!-- ======================= profile.html (updated) ======================= -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Profile ‚Äì DataDuels</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    .row { display:flex; align-items:center; justify-content:center; gap:16px; margin:12px 0; }
    .statsline { display:flex; gap:24px; justify-content:center; margin:16px 0; }
    .pill { display:inline-block; padding:10px 14px; border:1px solid #e5e7eb; border-radius:999px; background:#fff; font-weight:600; text-decoration:none; }
    .group { display:grid; gap:10px; margin-top:16px; }
  </style>
</head>
<body>
  <main class="page">
    <section class="card profile-card" aria-label="Profile">
      <div id="loading" style="text-align:center; padding:20px;">
        <p>Loading profile...</p>
      </div>

      <div id="profileContent" style="display:none;">
        <div class="profile-header">
          <div class="avatar-container">
            <img id="avatar" src="https://api.dicebear.com/7.x/identicon/svg?seed=runner" 
                 alt="Avatar" class="avatar-large" />
            <div class="avatar-badge">üèÉ</div>
          </div>
          <div class="profile-info">
            <h1 id="userName">Runner Name</h1>
            <p id="userInfo" class="profile-meta">@handle ‚Ä¢ Location</p>
          </div>
        </div>

        <div id="noDataWarning" class="warning-banner" style="display:none;">
          ‚ö†Ô∏è No activity data yet. <a href="index.html" style="color:inherit; font-weight:600; text-decoration:underline;">Sync your activities</a> to see your stats!
        </div>

        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="runs">0</div>
            <div class="stat-label">Runs</div>
          </div>
          <div class="stat-card highlight">
            <div class="stat-value" id="distance">0 km</div>
            <div class="stat-label">Distance</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="pace">0</div>
            <div class="stat-label">Avg Pace</div>
          </div>
          <div class="stat-card highlight">
            <div class="stat-value" id="score">0</div>
            <div class="stat-label">Score</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="cadence">0</div>
            <div class="stat-label">Avg Cadence</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="heartrate">0</div>
            <div class="stat-label">Avg HR</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="elevation">0</div>
            <div class="stat-label">Elevation</div>
          </div>
        </div>
      </div>

      <div id="error" style="display:none; padding:20px; text-align:center;">
        <p style="color:#ef4444;">[Error] Could not load profile</p>
        <a class="btn" id="connectStravaBtn">Connect Strava</a>
      </div>

      <div class="profile-actions" role="navigation" aria-label="Profile subpages">
        <a class="pill-btn" href="profile-challenges.html">
          <span>üèÖ</span> Challenges & Badges
        </a>
        <a class="pill-btn" href="profile-stats.html">
          <span>üìä</span> Detailed Stats
        </a>
      </div>
    </section>
  </main>

  <nav class="tabs" aria-label="Primary navigation">
    <div class="row">
      <a href="profile.html" aria-label="Profile" class="active"><div class="icon">Profile</div></a>
      <a href="index.html" aria-label="Home"><div class="icon">Home</div></a>
      <a href="social.html" aria-label="Social"><div class="icon">Social</div></a>
      <a href="routes.html" aria-label="Routes"><div class="icon">Routes</div></a>
    </div>
  </nav>

  <script type="module" src="api.js"></script>
  <script src="script.js"></script>
  <script type = "module">
    // Load profile data when page loads
    // async function loadProfile() {
    //   try {
    //     const data = await api.getProfile();
    //     console.log(data)
    //     // Update UI with data
    //     document.getElementById('userName').textContent = data.name;
    //     document.getElementById('userInfo').textContent = `@${data.username} ‚Ä¢ ${data.location}`;
    //     document.getElementById('avatar').src = data.avatar;
        
    //     document.getElementById('runs').textContent = data.stats.runs;
    //     document.getElementById('distance').textContent = data.stats.distance_km + ' km';
    //     document.getElementById('pace').textContent = data.stats.avg_pace.toFixed(1);
    //     document.getElementById('score').textContent = data.stats.score;
        
    //     // Show content, hide loading
    //     document.getElementById('loading').style.display = 'none';
    //     document.getElementById('profileContent').style.display = 'block';
    //   } catch (error) {
    //     console.error('Failed to load profile:', error);
    //     document.getElementById('loading').style.display = 'none';
    //     document.getElementById('error').style.display = 'block';
    //   }
    // }
    
    // Set up Connect Strava button
    document.getElementById('connectStravaBtn')?.addEventListener('click', () => {
      window.location.href = `${API_URL}/auth/strava`;
    });
    
    //Load profile data when page loads
    async function loadProfile() {
      try {
        const data = await api.getProfile();
        console.log('Profile data loaded:', data);
        
        // Update UI with data
        document.getElementById('userName').textContent = data.name;
        document.getElementById('userInfo').textContent = `@${data.username || 'unknown'} ‚Ä¢ ${data.location || ''}`;
        document.getElementById('avatar').src = data.avatar;
        
        document.getElementById('runs').textContent = data.stats.runs || 0;
        document.getElementById('distance').textContent = (data.stats.distance_km || 0) + ' km';
        document.getElementById('pace').textContent = (data.stats.avg_pace || 0).toFixed(1);
        document.getElementById('score').textContent = data.stats.score || 0;
        
        // Show warning if no data
        if (!data.stats.runs || data.stats.runs === 0) {
          document.getElementById('noDataWarning').style.display = 'block';
        }
        
        // Show content, hide loading
        document.getElementById('loading').style.display = 'none';
        document.getElementById('profileContent').style.display = 'block';
      } catch (error) {
        console.error('Failed to load profile:', error);
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error').style.display = 'block';
      }
    }
    
    // // Load on page ready
    // if (document.readyState === 'loading') {
    //   document.addEventListener('DOMContentLoaded', loadProfile);
    // } else {
    //   loadProfile();
    // }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', loadProfile_new);
    } else {
      loadProfile_new();
    }

    import { db } from "/strava_user_frontend.js";
    async function loadProfile_new() {
        const { data: { session } } = await db.auth.getSession();
        if (!session) {
            console.error("No active session found!");
            return;
        }

        const res = await fetch(`${API_URL}/person/get-activities`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            access_token: session.access_token
          })

        });

        // Parse the JSON response
        const data = await res.json();

        // // Log it in a readable format
        // console.log(data);
        const stats = {
          username: data.username,
          totalWorkouts: data.total_workouts,
          totalDistance: data.total_distance,
          averageSpeed: data.average_speed,
          maxSpeed: data.max_speed,
          streak: data.streak,
          badges: data.badges,
          weeklyChallenges: data.weekly_challenges
      };

      // Update profile info
      document.getElementById('userName').textContent = stats.username || 'Unknown';
      // You can add location if available in your backend
      document.getElementById('userInfo').textContent = `@${stats.username || 'unknown'}`;
      // If you have an avatar URL, set it; else, default image
      document.getElementById('avatar').src = data.avatar || '/default-avatar.png';

      // Update stats
      document.getElementById('distance').textContent = stats.totalDistance.toFixed(1) + ' km';
      document.getElementById('pace').textContent = stats.averageSpeed 
          ? (1000 / stats.averageSpeed / 60).toFixed(2) + ' min/km'  // m/s -> min/km
          : '0 min/km';
      document.getElementById('score').textContent = stats.totalWorkouts;  // or compute your own score
      document.getElementById('runs').textContent = stats.totalWorkouts;

      // Show warning if no runs
      if (!stats.totalWorkouts || stats.totalWorkouts === 0) {
          document.getElementById('noDataWarning').style.display = 'block';
      }

      // Show content, hide loading
      document.getElementById('loading').style.display = 'none';
      document.getElementById('profileContent').style.display = 'block';
      } catch (error) {
        console.error('Failed to load profile:', error);
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error').style.display = 'block';
      }
    }
    
    // Load on page ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', loadProfile);
    } else {
      loadProfile();
    }
  </script>
</body>
</html>

